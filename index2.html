<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Lumina Notes - –£–º–Ω—ã–π –±–ª–æ–∫–Ω–æ—Ç</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --primary-darker: #5b21b6;
            --secondary: #06b6d4;
            --accent: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-dark: #0a0a0f;
            --bg-darker: #050508;
            --bg-card: #111827;
            --bg-card-hover: #1f2937;
            --bg-hover: #1e1b2e;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #2d3748;
            --border-hover: #4c5180;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 40px rgba(124, 58, 237, 0.3);
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --gradient-dark: linear-gradient(135deg, var(--primary-darker), #0f766e);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            opacity: 0;
            animation: particleFloat 20s infinite linear;
        }

        .particle:nth-child(1) { top: 10%; left: 5%; width: 4px; height: 4px; animation-delay: 0s; background: var(--primary); }
        .particle:nth-child(2) { top: 20%; left: 80%; width: 6px; height: 6px; animation-delay: 2s; background: var(--secondary); }
        .particle:nth-child(3) { top: 60%; left: 10%; width: 3px; height: 3px; animation-delay: 4s; background: var(--accent); }
        .particle:nth-child(4) { top: 80%; left: 70%; width: 5px; height: 5px; animation-delay: 6s; background: var(--primary); }
        .particle:nth-child(5) { top: 30%; left: 60%; width: 4px; height: 4px; animation-delay: 8s; background: var(--secondary); }
        .particle:nth-child(6) { top: 70%; left: 40%; width: 3px; height: 3px; animation-delay: 10s; background: var(--accent); }
        .particle:nth-child(7) { top: 40%; left: 20%; width: 5px; height: 5px; animation-delay: 12s; background: var(--primary); }
        .particle:nth-child(8) { top: 90%; left: 30%; width: 4px; height: 4px; animation-delay: 14s; background: var(--secondary); }
        .particle:nth-child(9) { top: 15%; left: 50%; width: 3px; height: 3px; animation-delay: 16s; background: var(--accent); }
        .particle:nth-child(10) { top: 55%; left: 85%; width: 6px; height: 6px; animation-delay: 18s; background: var(--primary); }

        @keyframes particleFloat {
            0% {
                transform: translate(0, 0) rotate(0deg) scale(0.5);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            50% {
                transform: translate(100px, 100px) rotate(180deg) scale(1);
                opacity: 1;
            }
            90% {
                opacity: 0.3;
            }
            100% {
                transform: translate(200px, 50px) rotate(360deg) scale(0.3);
                opacity: 0;
            }
        }

        @keyframes bgPulse {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(236, 72, 153, 0.05) 0%, transparent 50%);
            background-size: 200% 200%;
            animation: bgPulse 15s ease infinite;
            z-index: -1;
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .auth-card {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 400px;
            position: relative;
            overflow: hidden;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 1.2rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.9rem;
            background: rgba(30, 41, 59, 0.5);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
            background: rgba(30, 41, 59, 0.8);
        }

        .error-message {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-top: 1.5rem;
        }

        .btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.9rem 1.8rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }

        .app-content {
            display: none;
        }

        header {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-radius: 20px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #7c3aed, #06b6d4, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            text-align: center;
            margin-top: 1rem;
            color: var(--text-secondary);
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .subscription-info-compact {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(5px);
            padding: 1rem 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        .subscription-status-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            font-size: 0.95rem;
            color: var(--text-primary);
            flex-wrap: wrap;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .compact-timer {
            background: var(--gradient);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .timer-display {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .timer-unit {
            display: flex;
            align-items: baseline;
            gap: 0.2rem;
        }

        .timer-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .timer-label {
            font-size: 0.7rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .timer-separator {
            margin: 0 0.2rem;
            opacity: 0.7;
        }

        .nav-tabs {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            background: rgba(17, 24, 39, 0.7);
            border: 2px solid var(--border);
            padding: 0.9rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tab.active {
            background: var(--gradient);
            border-color: var(--primary);
            color: white;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .subscription-status {
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.8rem;
        }

        .status-trial {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-forced-closed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: var(--shadow-glow);
        }

        h2 {
            color: var(--text-primary);
            margin-bottom: 1.2rem;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        textarea {
            width: 100%;
            height: 200px;
            background: rgba(30, 41, 59, 0.5);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.2rem;
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .buttons {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.2rem;
            flex-wrap: wrap;
        }

        .btn-app {
            background: rgba(17, 24, 39, 0.8);
            color: var(--text-primary);
            border: 2px solid var(--border);
            padding: 0.9rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-app:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .btn-app.primary {
            background: var(--gradient);
            border: none;
            color: white;
        }

        .btn-app:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #savedNotes {
            max-height: 400px;
            overflow-y: auto;
        }

        .note-item {
            background: rgba(30, 41, 59, 0.5);
            padding: 1.2rem;
            margin-bottom: 0.8rem;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .note-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.6rem;
        }

        .note-content {
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 0.8rem;
            white-space: pre-wrap;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .camera-preview {
            width: 100%;
            height: 400px;
            background: #0f172a;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        #scannerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .document-frame {
            width: 280px;
            height: 396px;
            border: 2px solid #00ff00;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-guide {
            color: white;
            margin-top: 1rem;
            font-weight: 500;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        .scanner-gallery {
            margin-bottom: 1rem;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .scanned-image {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .scanned-image img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .remove-scan {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .camera-controls {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .support-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .support-messages {
            max-height: 400px;
            overflow-y: auto;
        }

        .support-message {
            background: rgba(30, 41, 59, 0.5);
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 12px;
            border-left: 4px solid var(--secondary);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-user {
            font-weight: 500;
            color: var(--text-primary);
        }

        .message-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .message-content {
            color: var(--text-primary);
            line-height: 1.5;
        }

        .message-status {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-answered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(17, 24, 39, 0.9);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            z-index: 1000;
            display: none;
        }

        .notification.show {
            display: block;
        }

        .feature-blocked {
            position: relative;
        }

        .blocked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 10;
        }

        .blocked-message {
            background: rgba(17, 24, 39, 0.9);
            padding: 2rem;
            border-radius: 12px;
            border: 2px solid var(--error);
            text-align: center;
            max-width: 300px;
        }

        .activation-form {
            background: rgba(30, 41, 59, 0.5);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 1.5rem;
        }

        .activation-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .activation-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .telegram-link {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 500;
        }

        .activation-success-special {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(124, 58, 237, 0.1));
            border: 2px solid var(--success);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            text-align: center;
        }

        .celebration-text {
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--success), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--success);
            animation: confetti-fall 5s linear forwards;
            z-index: 1000;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .camera-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .alternative-options {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .file-input-info {
            background: rgba(30, 41, 59, 0.5);
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .file-input-button {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .nav-tabs { flex-direction: column; }
            .camera-controls { flex-direction: column; }
            .btn-app { min-width: 180px; }
            .document-frame { width: 220px; height: 311px; }
        }
    </style>
</head>
<body>
    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="notification" id="notification"></div>

    <div class="auth-container" id="authContainer">
        <div class="auth-card" id="loginForm">
            <h2 class="auth-title">–í—Ö–æ–¥ –≤ Lumina Notes</h2>
            <div class="form-group">
                <label for="loginUsername">–õ–æ–≥–∏–Ω:</label>
                <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω" maxlength="20">
                <div class="error-message" id="loginUsernameError"></div>
            </div>
            <div class="form-group">
                <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å" maxlength="30">
                <div class="error-message" id="loginPasswordError"></div>
            </div>
            <div class="auth-buttons">
                <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
                <button class="btn btn-secondary" onclick="showRegisterForm()">–£ –º–µ–Ω—è –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            </div>
        </div>

        <div class="auth-card" id="registerForm" style="display: none;">
            <h2 class="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="form-group">
                <label for="registerUsername">–õ–æ–≥–∏–Ω (3-20 —Å–∏–º–≤–æ–ª–æ–≤):</label>
                <input type="text" id="registerUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" maxlength="20">
                <div class="error-message" id="registerUsernameError"></div>
            </div>
            <div class="form-group">
                <label for="registerPassword">–ü–∞—Ä–æ–ª—å (6+ —Å–∏–º–≤–æ–ª–æ–≤):</label>
                <input type="password" id="registerPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" maxlength="30">
                <div class="error-message" id="registerPasswordError"></div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                <input type="password" id="confirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" maxlength="30">
                <div class="error-message" id="confirmPasswordError"></div>
            </div>
            <div class="auth-buttons">
                <button class="btn" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button class="btn btn-secondary" onclick="showLoginForm()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</button>
            </div>
        </div>
    </div>

    <div class="app-content" id="appContent">
        <div class="container">
            <header>
                <h1>‚ú® Lumina Notes</h1>
                <div class="user-info">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="currentUserName"></span>!
                    <span id="subscriptionBadge" class="subscription-status status-trial">–ü—Ä–æ–±–Ω—ã–π (30–¥)</span>
                    <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </header>

            <div class="subscription-info-compact">
                <div class="subscription-status-line">
                    <div class="status-info">
                        <span>üìÖ</span>
                        <span id="subscriptionStatusText">–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</span>
                        <span id="subscriptionDaysLeft">(30 –¥–Ω–µ–π)</span>
                    </div>
                    <div class="compact-timer" id="compactTimer">
                        <span>‚è∞</span>
                        <div class="timer-display">
                            <div class="timer-unit">
                                <span class="timer-value" id="compactDays">30</span>
                                <span class="timer-label">–¥</span>
                            </div>
                            <span class="timer-separator">:</span>
                            <div class="timer-unit">
                                <span class="timer-value" id="compactHours">00</span>
                                <span class="timer-label">—á</span>
                            </div>
                            <span class="timer-separator">:</span>
                            <div class="timer-unit">
                                <span class="timer-value" id="compactMinutes">00</span>
                                <span class="timer-label">–º</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('notes')">
                    <span>üìù</span> –ó–∞–º–µ—Ç–∫–∏
                </div>
                <div class="nav-tab" onclick="switchTab('scanner')">
                    <span>üì∑</span> –°–∫–∞–Ω–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                </div>
                <div class="nav-tab" onclick="switchTab('subscription')">
                    <span>üíé</span> –ü–æ–¥–ø–∏—Å–∫–∞
                </div>
                <div class="nav-tab" onclick="switchTab('support')">
                    <span>üí¨</span> –ü–æ–¥–¥–µ—Ä–∂–∫–∞
                </div>
            </div>

            <div class="tab-content active" id="notesTab">
                <div class="main-content">
                    <div class="card">
                        <h2>üéØ –ë—ã—Å—Ç—Ä–∞—è –∑–∞–º–µ—Ç–∫–∞</h2>
                        <textarea id="noteText" placeholder="üí´ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –º—ã—Å–ª–∏ –∑–¥–µ—Å—å..." maxlength="5000"></textarea>
                        <div class="buttons">
                            <button class="btn-app primary" onclick="saveNote()">
                                <span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button class="btn-app warning" onclick="clearNote()">
                                <span>üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üìö –í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏</h2>
                        <div id="savedNotes"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="scannerTab">
                <div class="card feature-blocked" id="scannerCard">
                    <h2>üì∑ –°–∫–∞–Ω–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
                    
                    <div class="camera-error" id="cameraError" style="display: none;">
                        <h3>‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.</p>
                        <div class="alternative-options">
                            <div class="file-input-wrapper">
                                <button class="btn-app primary file-input-button" id="altFileButton">
                                    <span>üìÅ</span> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
                                </button>
                                <input type="file" id="fileInputAlt" accept="image/*" multiple style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="scanner-container">
                        <div class="camera-preview" id="cameraPreview">
                            <video id="scannerVideo" autoplay playsinline></video>
                            <div class="scanner-overlay">
                                <div class="document-frame"></div>
                                <div class="scan-guide">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç</div>
                            </div>
                        </div>
                        
                        <div class="file-input-info">
                            <strong>üí° –°–æ–≤–µ—Ç:</strong> –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
                        </div>
                        
                        <div class="scanner-gallery" id="scannerGallery">
                            <div class="gallery-header">
                                <span>üì∏ –°–Ω–∏–º–∫–∏: <span id="imageCount">0</span></span>
                                <button class="btn-app primary" onclick="createPDFFromImages()" id="createPDFBtn">
                                    <span>üìÑ</span> –°–æ–∑–¥–∞—Ç—å PDF
                                </button>
                            </div>
                            <div class="images-grid" id="imagesGrid"></div>
                        </div>
                        
                        <div class="camera-controls">
                            <button class="btn-app primary" onclick="captureScan()" id="captureBtn">
                                <span>üì∏</span> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn-app" onclick="toggleCamera()" id="toggleCameraBtn">
                                <span>üîÑ</span> –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                            </button>
                            
                            <div class="file-input-wrapper">
                                <button class="btn-app file-input-button" id="fileButton">
                                    <span>üìÅ</span> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                                </button>
                                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                            </div>
                            
                            <button class="btn-app warning" onclick="clearScanner()">
                                <span>üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                            </button>
                        </div>
                    </div>
                    <div class="blocked-overlay" id="scannerBlockedOverlay" style="display: none;">
                        <div class="blocked-message">
                            <h3>üö´ –î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç</h3>
                            <p>–§—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞.</p>
                            <button class="btn-app primary" onclick="switchTab('subscription')" style="margin-top: 1rem;">
                                üíé –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="subscriptionTab">
                <div class="main-content">
                    <div class="card">
                        <h2>üíé –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
                        <div id="subscriptionManagementContent"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="supportTab">
                <div class="main-content">
                    <div class="card">
                        <h2>üí¨ –û–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</h2>
                        <div class="support-form">
                            <div class="form-group">
                                <label for="supportCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è:</label>
                                <select id="supportCategory">
                                    <option value="technical">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞</option>
                                    <option value="subscription">üíé –í–æ–ø—Ä–æ—Å –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ</option>
                                    <option value="feature">‚ú® –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É</option>
                                    <option value="other">üìå –î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="supportMessage">–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                                <textarea id="supportMessage" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å..." maxlength="2000"></textarea>
                            </div>
                            <div class="buttons">
                                <button class="btn-app primary" onclick="sendSupportMessage()">
                                    <span>üì®</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üì® –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π</h2>
                        <div class="support-messages" id="supportMessages"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStream = null;
        let capturedImages = [];
        let useFrontCamera = false;
        let cameraError = false;

        const IMAGE_STORAGE_KEY = 'lumina_scanner_images';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤
        function initializeFileInputs() {
            const fileInput = document.getElementById('fileInput');
            const fileInputAlt = document.getElementById('fileInputAlt');
            const fileButton = document.getElementById('fileButton');
            const altFileButton = document.getElementById('altFileButton');
            
            if (fileInput && fileButton) {
                fileButton.addEventListener('click', function() {
                    fileInput.click();
                });
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            if (fileInputAlt && altFileButton) {
                altFileButton.addEventListener('click', function() {
                    fileInputAlt.click();
                });
                fileInputAlt.addEventListener('change', handleFileSelect);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const subscriptionStatus = getUserSubscriptionStatus();
            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') {
                showNotification('‚ùå –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.', 'error');
                return;
            }

            let loadedCount = 0;
            const totalFiles = files.length;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (!file.type.match('image.*')) {
                    showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                    continue;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`‚ùå –§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 10MB)`, 'error');
                    continue;
                }

                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    
                    const img = new Image();
                    img.onload = function() {
                        const newImage = {
                            id: Date.now() + i,
                            data: imageData,
                            name: file.name,
                            size: `${img.width}x${img.height}`,
                            fileSize: formatFileSize(file.size),
                            timestamp: new Date().toISOString(),
                            source: 'file'
                        };
                        
                        capturedImages.push(newImage);
                        loadedCount++;
                        
                        logUserAction('scan_single', `–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª –∏–∑ –º–µ–¥–∏–∞—Ç–µ–∫–∏: ${file.name}`, null, [newImage]);
                        displayScannedImages();
                        
                        if (loadedCount === totalFiles) {
                            showNotification(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loadedCount} —Ñ–∞–π–ª–æ–≤ –∏–∑ –º–µ–¥–∏–∞—Ç–µ–∫–∏!`, 'success');
                        }
                    };
                    img.src = imageData;
                };
                
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function createConfetti() {
            const colors = ['#7c3aed', '#06b6d4', '#ec4899', '#10b981', '#f59e0b'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        function checkFeatureAccess() {
            const subscriptionStatus = getUserSubscriptionStatus();
            const scannerOverlay = document.getElementById('scannerBlockedOverlay');

            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') {
                if (scannerOverlay) scannerOverlay.style.display = 'flex';
                stopCamera();
            } else {
                if (scannerOverlay) scannerOverlay.style.display = 'none';
            }
        }

        function loadSubscriptionManagementContent() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;

            const subscriptionStatus = getUserSubscriptionStatus();
            const managementContent = document.getElementById('subscriptionManagementContent');

            let statusInfo = '';
            if (subscriptionStatus.status === 'active') {
                statusInfo = `<p>‚úÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ: <strong>${subscriptionStatus.endDate.toLocaleDateString('ru-RU')}</strong></p>`;
            } else if (subscriptionStatus.status === 'trial') {
                statusInfo = `<p>üÜì –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç–µ–∫–∞–µ—Ç: <strong>${subscriptionStatus.endDate.toLocaleDateString('ru-RU')}</strong></p>`;
            } else if (subscriptionStatus.status === 'forced_closed') {
                statusInfo = `<p style="color: var(--error);">üö´ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>`;
            } else {
                statusInfo = `<p>‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º.</p>`;
            }

            managementContent.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</h3>
                    ${statusInfo}
                </div>
                
                <div class="activation-form">
                    <h3>üîë –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h3>
                    <div class="form-group">
                        <label for="activationCode">–ö–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:</label>
                        <input type="text" id="activationCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –∏–ª–∏ –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏" style="font-family: monospace; letter-spacing: 1px;">
                    </div>
                    <button class="btn-app primary" onclick="activateSubscription()">
                        <span>‚ö°</span> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                    </button>
                    <div id="activationMessage" style="margin-top: 1rem;"></div>
                </div>
            `;
        }

        function activateSubscription() {
            const code = document.getElementById('activationCode').value.trim().toUpperCase();
            const messageDiv = document.getElementById('activationMessage');

            if (!code) {
                messageDiv.innerHTML = '<div class="activation-error">‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</div>';
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                messageDiv.innerHTML = '<div class="activation-error">‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</div>';
                return;
            }

            const promoCodes = JSON.parse(localStorage.getItem('lumina_promocodes')) || [];
            const activationCodes = JSON.parse(localStorage.getItem('lumina_activation_codes')) || [];

            let validCode = promoCodes.find(p => p.code === code && p.active) || 
                           activationCodes.find(a => a.code === code && a.active);

            if (!validCode) {
                messageDiv.innerHTML = '<div class="activation-error">‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</div>';
                return;
            }

            const users = JSON.parse(localStorage.getItem('lumina_users'));
            const userIndex = users.findIndex(u => u.id === currentUser.id);

            if (userIndex === -1) {
                messageDiv.innerHTML = '<div class="activation-error">‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                return;
            }

            const now = new Date();
            const subscriptionEnd = new Date(now.getTime() + validCode.duration * 24 * 60 * 60 * 1000);

            // –°–Ω–∏–º–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –µ—Å–ª–∏ –±—ã–ª–æ
            const subscriptionClosures = JSON.parse(localStorage.getItem('lumina_subscription_closures')) || [];
            const updatedClosures = subscriptionClosures.map(closure => {
                if (closure.userId === currentUser.id && closure.active) {
                    return { ...closure, active: false };
                }
                return closure;
            });
            localStorage.setItem('lumina_subscription_closures', JSON.stringify(updatedClosures));

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            users[userIndex].subscriptionActive = true;
            users[userIndex].subscriptionStart = now.toISOString();
            users[userIndex].subscriptionEnd = subscriptionEnd.toISOString();
            users[userIndex].activationMethod = promoCodes.find(p => p.code === code) ? 'promo' : 'activation';
            users[userIndex].trialStart = null;

            localStorage.setItem('lumina_users', JSON.stringify(users));

            const updatedUser = users[userIndex];
            localStorage.setItem('currentUser', JSON.stringify(updatedUser));

            // –ü–æ–º–µ—á–∞–µ–º –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
            if (promoCodes.find(p => p.code === code)) {
                const promoIndex = promoCodes.findIndex(p => p.code === code);
                promoCodes[promoIndex].active = false;
                promoCodes[promoIndex].usedBy = currentUser.username;
                promoCodes[promoIndex].usedAt = now.toISOString();
                localStorage.setItem('lumina_promocodes', JSON.stringify(promoCodes));
            } else {
                const activationIndex = activationCodes.findIndex(a => a.code === code);
                activationCodes[activationIndex].active = false;
                activationCodes[activationIndex].usedBy = currentUser.username;
                activationCodes[activationIndex].usedAt = now.toISOString();
                localStorage.setItem('lumina_activation_codes', JSON.stringify(activationCodes));
            }

            messageDiv.innerHTML = `
                <div class="activation-success-special">
                    <div class="celebration-text">üéâ –ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!</div>
                    <div style="color: var(--text-primary);">
                        <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${validCode.duration} –¥–Ω–µ–π<br>
                        <strong>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ:</strong> ${subscriptionEnd.toLocaleDateString('ru-RU')}
                    </div>
                </div>
            `;

            createConfetti();
            document.getElementById('activationCode').value = '';
            startSubscriptionTimer();
            checkFeatureAccess();
            loadSubscriptionManagementContent();
            logUserAction('subscription', `–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ —Å –∫–æ–¥–æ–º ${code} –Ω–∞ ${validCode.duration} –¥–Ω–µ–π`);
        }

        function sendSupportMessage() {
            const category = document.getElementById('supportCategory').value;
            const message = document.getElementById('supportMessage').value.trim();
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (!message) {
                showNotification('üìù –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!', 'warning');
                return;
            }

            if (!currentUser) {
                showNotification('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                return;
            }

            const supportMessages = JSON.parse(localStorage.getItem('support_messages')) || [];
            const newMessage = {
                id: Date.now(),
                user: currentUser.username,
                category: category,
                message: message,
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            supportMessages.push(newMessage);
            localStorage.setItem('support_messages', JSON.stringify(supportMessages));

            logUserAction('support', `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É (${category})`, message);
            document.getElementById('supportMessage').value = '';
            showNotification('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!', 'success');
            loadSupportMessages();
        }

        function loadSupportMessages() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;

            const supportMessages = JSON.parse(localStorage.getItem('support_messages')) || [];
            const messagesContainer = document.getElementById('supportMessages');
            
            const userMessages = supportMessages.filter(msg => msg.user === currentUser.username);

            if (userMessages.length === 0) {
                messagesContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">üì® –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</div>';
                return;
            }

            userMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            messagesContainer.innerHTML = '';

            userMessages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = 'support-message';
                
                const statusBadge = msg.status === 'answered' ? 
                    '<span class="message-status status-answered">‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω</span>' :
                    '<span class="message-status status-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞</span>';
                
                messageElement.innerHTML = `
                    <div class="message-header">
                        <div>
                            <span class="message-user">${msg.user}</span>
                            ${statusBadge}
                        </div>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleDateString('ru-RU')}</div>
                    </div>
                    <div class="message-content">
                        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${getCategoryName(msg.category)}<br><br>
                        ${msg.message}
                    </div>
                `;
                messagesContainer.appendChild(messageElement);
            });
        }

        function getCategoryName(category) {
            const categories = {
                'technical': 'üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞',
                'subscription': 'üíé –í–æ–ø—Ä–æ—Å –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ',
                'feature': '‚ú® –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É',
                'other': 'üìå –î—Ä—É–≥–æ–µ'
            };
            return categories[category] || category;
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabName === 'scanner') {
                setTimeout(startCamera, 100);
            } else {
                stopCamera();
            }

            if (tabName === 'support') loadSupportMessages();
            if (tabName === 'subscription') loadSubscriptionManagementContent();
            checkFeatureAccess();
        }

        function clearAuthErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearAuthErrors();
        }

        function showLoginForm() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearAuthErrors();
        }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function saveImageToStorage(imageData, imageId) {
            try {
                const images = JSON.parse(localStorage.getItem(IMAGE_STORAGE_KEY)) || {};
                images[imageId] = imageData;
                localStorage.setItem(IMAGE_STORAGE_KEY, JSON.stringify(images));
                return true;
            } catch (e) {
                return false;
            }
        }

        function logUserAction(type, details, content = null, images = null) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;

            let imageReferences = null;
            if (images && images.length > 0) {
                imageReferences = images.map(img => {
                    const imageId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    saveImageToStorage(img.data, imageId);
                    return {
                        id: imageId,
                        name: img.name,
                        size: img.size,
                        timestamp: img.timestamp
                    };
                });
            }

            const action = {
                id: Date.now(),
                user: currentUser.username,
                type: type,
                details: details,
                content: content,
                images: imageReferences,
                timestamp: new Date().toISOString()
            };

            let history = JSON.parse(localStorage.getItem('admin_history')) || [];
            history.push(action);
            localStorage.setItem('admin_history', JSON.stringify(history));
        }

        function initializeData() {
            if (!localStorage.getItem('lumina_users')) localStorage.setItem('lumina_users', JSON.stringify([]));
            if (!localStorage.getItem('admin_history')) localStorage.setItem('admin_history', JSON.stringify([]));
            if (!localStorage.getItem('lumina_subscription_closures')) localStorage.setItem('lumina_subscription_closures', JSON.stringify([]));
            if (!localStorage.getItem('support_messages')) localStorage.setItem('support_messages', JSON.stringify([]));
            if (!localStorage.getItem('lumina_promocodes')) localStorage.setItem('lumina_promocodes', JSON.stringify([]));
            if (!localStorage.getItem('lumina_activation_codes')) localStorage.setItem('lumina_activation_codes', JSON.stringify([]));
            if (!localStorage.getItem(IMAGE_STORAGE_KEY)) localStorage.setItem(IMAGE_STORAGE_KEY, JSON.stringify({}));
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            clearAuthErrors();
            let hasErrors = false;

            if (!username) {
                document.getElementById('loginUsernameError').textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω';
                document.getElementById('loginUsernameError').style.display = 'block';
                hasErrors = true;
            }

            if (!password) {
                document.getElementById('loginPasswordError').textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                document.getElementById('loginPasswordError').style.display = 'block';
                hasErrors = true;
            }

            if (hasErrors) return;

            const users = JSON.parse(localStorage.getItem('lumina_users')) || [];
            const hashedPassword = hashPassword(password);
            const user = users.find(u => u.username === username);

            if (user) {
                if (user.password === hashedPassword) {
                    if (!user.trialStart) {
                        user.trialStart = new Date().toISOString();
                        const userIndex = users.findIndex(u => u.username === username);
                        if (userIndex !== -1) {
                            users[userIndex].trialStart = user.trialStart;
                            localStorage.setItem('lumina_users', JSON.stringify(users));
                        }
                    }
                    
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('currentUserName').textContent = user.username;
                    
                    logUserAction('login', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É');
                    showNotification(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.username}!`, 'success');
                    
                    loadUserNotes();
                    startSubscriptionTimer();
                    checkFeatureAccess();
                    loadSubscriptionManagementContent();
                    initializeFileInputs();
                } else {
                    document.getElementById('loginPasswordError').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                    document.getElementById('loginPasswordError').style.display = 'block';
                }
            } else {
                document.getElementById('loginUsernameError').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                document.getElementById('loginUsernameError').style.display = 'block';
            }
        }

        function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            clearAuthErrors();
            let hasErrors = false;

            if (username.length < 3 || username.length > 20) {
                document.getElementById('registerUsernameError').textContent = '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤';
                document.getElementById('registerUsernameError').style.display = 'block';
                hasErrors = true;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                document.getElementById('registerUsernameError').textContent = '–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _';
                document.getElementById('registerUsernameError').style.display = 'block';
                hasErrors = true;
            }

            if (password.length < 6) {
                document.getElementById('registerPasswordError').textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                document.getElementById('registerPasswordError').style.display = 'block';
                hasErrors = true;
            }

            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                document.getElementById('confirmPasswordError').style.display = 'block';
                hasErrors = true;
            }

            if (hasErrors) return;

            const users = JSON.parse(localStorage.getItem('lumina_users')) || [];
            
            if (users.find(user => user.username.toLowerCase() === username.toLowerCase())) {
                document.getElementById('registerUsernameError').textContent = '–õ–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç';
                document.getElementById('registerUsernameError').style.display = 'block';
                return;
            }

            const hashedPassword = hashPassword(password);
            const newUser = {
                id: Date.now(),
                username: username,
                password: hashedPassword,
                registered: new Date().toISOString(),
                trialStart: new Date().toISOString(),
                pdfCount: 0
            };

            users.push(newUser);
            localStorage.setItem('lumina_users', JSON.stringify(users));
            logUserAction('register', '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
            showNotification('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
            showLoginForm();
        }

        function getUserSubscriptionStatus() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return { status: 'inactive', daysLeft: 0 };

            const subscriptionClosures = JSON.parse(localStorage.getItem('lumina_subscription_closures')) || [];
            const forcedClosure = subscriptionClosures.find(closure => 
                closure.userId === currentUser.id && closure.active
            );

            if (forcedClosure) return { status: 'forced_closed', daysLeft: 0 };

            if (currentUser.trialStart) {
                const trialStart = new Date(currentUser.trialStart);
                const trialEnd = new Date(trialStart.getTime() + 30 * 24 * 60 * 60 * 1000);
                const now = new Date();
                
                if (now < trialEnd) {
                    const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                    return { status: 'trial', daysLeft: daysLeft, endDate: trialEnd };
                }
            }

            if (currentUser.subscriptionActive && currentUser.subscriptionEnd) {
                const subscriptionEnd = new Date(currentUser.subscriptionEnd);
                const now = new Date();
                
                if (now < subscriptionEnd) {
                    const daysLeft = Math.ceil((subscriptionEnd - now) / (1000 * 60 * 60 * 24));
                    return { status: 'active', daysLeft: daysLeft, endDate: subscriptionEnd };
                }
            }

            return { status: 'inactive', daysLeft: 0 };
        }

        function startSubscriptionTimer() {
            if (window.subscriptionTimer) clearInterval(window.subscriptionTimer);
            window.subscriptionTimer = setInterval(updateSubscriptionTimer, 1000);
            updateSubscriptionTimer();
        }

        function updateSubscriptionTimer() {
            const subscriptionStatus = getUserSubscriptionStatus();
            const statusText = document.getElementById('subscriptionStatusText');
            const daysLeftElement = document.getElementById('subscriptionDaysLeft');
            const badgeElement = document.getElementById('subscriptionBadge');

            if (subscriptionStatus.status === 'forced_closed') {
                statusText.textContent = '–ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞';
                daysLeftElement.textContent = '';
                badgeElement.textContent = 'üö´ –ó–∞–∫—Ä—ã—Ç–∞';
                badgeElement.className = 'subscription-status status-forced-closed';
                checkFeatureAccess();
                return;
            }

            if (subscriptionStatus.status === 'inactive') {
                statusText.textContent = '–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞';
                daysLeftElement.textContent = '';
                badgeElement.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
                badgeElement.className = 'subscription-status status-inactive';
                return;
            }

            if (subscriptionStatus.endDate) {
                const now = new Date();
                const diff = subscriptionStatus.endDate - now;

                if (diff <= 0) {
                    statusText.textContent = subscriptionStatus.status === 'trial' ? '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è' : '–ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å';
                    daysLeftElement.textContent = '';
                    badgeElement.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
                    badgeElement.className = 'subscription-status status-inactive';
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                document.getElementById('compactDays').textContent = days;
                document.getElementById('compactHours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('compactMinutes').textContent = minutes.toString().padStart(2, '0');
                
                statusText.textContent = subscriptionStatus.status === 'trial' ? '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥' : '–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞';
                daysLeftElement.textContent = ` (${days} –¥–Ω–µ–π)`;
                
                if (subscriptionStatus.status === 'trial') {
                    badgeElement.textContent = `–ü—Ä–æ–±–Ω—ã–π (${days}–¥)`;
                    badgeElement.className = 'subscription-status status-trial';
                } else {
                    badgeElement.textContent = `–ê–∫—Ç–∏–≤–Ω–∞ (${days}–¥)`;
                    badgeElement.className = 'subscription-status status-active';
                }
            }
        }

        function saveNote() {
            const subscriptionStatus = getUserSubscriptionStatus();
            
            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') {
                showNotification('‚ùå –§—É–Ω–∫—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.', 'error');
                return;
            }

            const text = document.getElementById('noteText').value;
            if (text.trim() === '') {
                showNotification('üìù –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!', 'warning');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;

            const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.username}`)) || [];
            const newNote = {
                id: Date.now(),
                content: text,
                created: new Date().toISOString()
            };
            userNotes.unshift(newNote);
            localStorage.setItem(`notes_${currentUser.username}`, JSON.stringify(userNotes));
            
            logUserAction('create', '–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞', text);
            showNotification('‚úÖ –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
            loadUserNotes();
            clearNote();
        }

        function clearNote() {
            document.getElementById('noteText').value = '';
        }

        function loadUserNotes() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;

            const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.username}`)) || [];
            const notesContainer = document.getElementById('savedNotes');

            if (userNotes.length === 0) {
                notesContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">üìù –ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }

            notesContainer.innerHTML = '';
            userNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                noteElement.innerHTML = `
                    <div class="note-date">${new Date(note.created).toLocaleDateString('ru-RU')}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-actions">
                        <button class="btn-app primary" onclick="editNote(${note.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-app warning" onclick="deleteNote(${note.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                notesContainer.appendChild(noteElement);
            });
        }

        function editNote(noteId) {
            const subscriptionStatus = getUserSubscriptionStatus();
            
            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') {
                showNotification('‚ùå –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.', 'error');
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;

            const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.username}`)) || [];
            const note = userNotes.find(n => n.id === noteId);
            
            if (note) {
                document.getElementById('noteText').value = note.content;
                const noteIndex = userNotes.findIndex(n => n.id === noteId);
                userNotes.splice(noteIndex, 1);
                localStorage.setItem(`notes_${currentUser.username}`, JSON.stringify(userNotes));
                logUserAction('edit', '–ó–∞–º–µ—Ç–∫–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞', note.content);
                loadUserNotes();
            }
        }

        function deleteNote(noteId) {
            const subscriptionStatus = getUserSubscriptionStatus();
            
            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') {
                showNotification('‚ùå –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.', 'error');
                return;
            }

            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) return;

                const userNotes = JSON.parse(localStorage.getItem(`notes_${currentUser.username}`)) || [];
                const noteIndex = userNotes.findIndex(note => note.id === noteId);
                
                if (noteIndex !== -1) {
                    const deletedNote = userNotes[noteIndex];
                    userNotes.splice(noteIndex, 1);
                    localStorage.setItem(`notes_${currentUser.username}`, JSON.stringify(userNotes));
                    logUserAction('delete', '–ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞', deletedNote.content);
                    showNotification('üóëÔ∏è –ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                    loadUserNotes();
                }
            }
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ö–ê–ú–ï–†–´
        async function startCamera() {
            const subscriptionStatus = getUserSubscriptionStatus();
            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') return;

            stopCamera();
            cameraError = false;

            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–º–µ—Ä—É');
                }

                const constraints = {
                    video: {
                        facingMode: useFrontCamera ? 'user' : 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('scannerVideo');
                video.srcObject = currentStream;
                
                document.getElementById('cameraError').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'flex';
                document.getElementById('cameraPreview').style.display = 'block';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                cameraError = true;
                document.getElementById('cameraError').style.display = 'block';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('cameraPreview').style.display = 'none';
            }
        }

        async function captureScan() {
            const subscriptionStatus = getUserSubscriptionStatus();
            
            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') {
                showNotification('‚ùå –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.', 'error');
                return;
            }

            if (cameraError) {
                showNotification('‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                return;
            }

            const video = document.getElementById('scannerVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            const newImage = {
                id: Date.now(),
                data: imageData,
                name: `scan-${new Date().toLocaleString('ru-RU').replace(/[/:\\]/g, '-')}.jpg`,
                size: `${canvas.width}x${canvas.height}`,
                timestamp: new Date().toISOString(),
                source: 'camera'
            };
            
            capturedImages.push(newImage);
            logUserAction('scan_single', `–°–¥–µ–ª–∞–Ω–æ —Ñ–æ—Ç–æ —Å–∫–∞–Ω–µ—Ä–∞`, null, [newImage]);
            displayScannedImages();
            showNotification('üì∏ –î–æ–∫—É–º–µ–Ω—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!', 'success');
        }

        function displayScannedImages() {
            const grid = document.getElementById('imagesGrid');
            const imageCount = document.getElementById('imageCount');
            
            grid.innerHTML = '';
            imageCount.textContent = capturedImages.length;
            
            capturedImages.forEach((image, index) => {
                const imageElement = document.createElement('div');
                imageElement.className = 'scanned-image';
                imageElement.innerHTML = `
                    <img src="${image.data}" alt="–°–∫–∞–Ω ${index + 1}">
                    <button class="remove-scan" onclick="removeScan(${image.id})">√ó</button>
                `;
                grid.appendChild(imageElement);
            });
            
            document.getElementById('createPDFBtn').style.display = capturedImages.length > 0 ? 'flex' : 'none';
        }

        function removeScan(imageId) {
            capturedImages = capturedImages.filter(img => img.id !== imageId);
            displayScannedImages();
        }

        function toggleCamera() {
            useFrontCamera = !useFrontCamera;
            startCamera();
        }

        // –ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø PDF
        async function createPDFFromImages() {
            const subscriptionStatus = getUserSubscriptionStatus();
            if (subscriptionStatus.status === 'forced_closed' || subscriptionStatus.status === 'inactive') {
                showNotification('‚ùå –§—É–Ω–∫—Ü–∏—è PDF –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.', 'error');
                return;
            }

            if (capturedImages.length === 0) {
                showNotification('‚ùå –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è PDF', 'error');
                return;
            }

            showNotification('üìÑ –°–æ–∑–¥–∞–Ω–∏–µ PDF...', 'info');

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                const imagesForHistory = capturedImages.map(img => ({
                    data: img.data,
                    name: img.name,
                    size: img.size,
                    timestamp: img.timestamp
                }));

                for (let i = 0; i < capturedImages.length; i++) {
                    const image = capturedImages[i];
                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = image.data;
                    });

                    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
                    const imgAspectRatio = img.width / img.height;
                    const pdfAspectRatio = pdfWidth / pdfHeight;

                    let finalWidth, finalHeight, x, y;

                    if (imgAspectRatio > pdfAspectRatio) {
                        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∏—Ä–µ, —á–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ
                        finalWidth = pdfWidth - 40; // –û—Ç—Å—Ç—É–ø—ã –ø–æ 20px —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
                        finalHeight = finalWidth / imgAspectRatio;
                        x = 20;
                        y = (pdfHeight - finalHeight) / 2;
                    } else {
                        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—à–µ, —á–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
                        finalHeight = pdfHeight - 40; // –û—Ç—Å—Ç—É–ø—ã –ø–æ 20px —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
                        finalWidth = finalHeight * imgAspectRatio;
                        x = (pdfWidth - finalWidth) / 2;
                        y = 20;
                    }

                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
                    if (finalWidth > pdfWidth - 40) {
                        finalWidth = pdfWidth - 40;
                        finalHeight = finalWidth / imgAspectRatio;
                        x = 20;
                        y = (pdfHeight - finalHeight) / 2;
                    }

                    if (finalHeight > pdfHeight - 40) {
                        finalHeight = pdfHeight - 40;
                        finalWidth = finalHeight * imgAspectRatio;
                        x = (pdfWidth - finalWidth) / 2;
                        y = 20;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    pdf.addImage({
                        imageData: image.data,
                        format: 'JPEG',
                        x: x,
                        y: y,
                        width: finalWidth,
                        height: finalHeight
                    });
                }

                const fileName = `scanned-documents-${new Date().getTime()}.pdf`;
                pdf.save(fileName);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ PDF
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    const users = JSON.parse(localStorage.getItem('lumina_users')) || [];
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1) {
                        users[userIndex].pdfCount = (users[userIndex].pdfCount || 0) + 1;
                        localStorage.setItem('lumina_users', JSON.stringify(users));
                        currentUser.pdfCount = users[userIndex].pdfCount;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                }
                
                const sourceTypes = [...new Set(capturedImages.map(img => img.source))];
                const sourceText = sourceTypes.length === 1 ? 
                    (sourceTypes[0] === 'camera' ? '—Å–∫–∞–Ω–æ–≤ —Å –∫–∞–º–µ—Ä—ã' : '—Ñ–∞–π–ª–æ–≤ –∏–∑ –º–µ–¥–∏–∞—Ç–µ–∫–∏') : 
                    '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤';
                
                logUserAction('scan', `–°–æ–∑–¥–∞–Ω PDF –∏–∑ ${capturedImages.length} ${sourceText}`, null, imagesForHistory);
                showNotification(`‚úÖ PDF —Å–æ–∑–¥–∞–Ω –∏–∑ ${capturedImages.length} —Å—Ç—Ä–∞–Ω–∏—Ü!`, 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF: ' + error.message, 'error');
            }
        }

        function clearScanner() {
            if (capturedImages.length === 0) {
                showNotification('üßπ –°–∫–∞–Ω–µ—Ä —É–∂–µ –æ—á–∏—â–µ–Ω', 'info');
                return;
            }
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${capturedImages.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π?`)) {
                capturedImages = [];
                displayScannedImages();
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function logout() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) logUserAction('logout', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            
            stopCamera();
            localStorage.removeItem('currentUser');
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('loginForm').style.display = 'block';
            
            if (window.subscriptionTimer) clearInterval(window.subscriptionTimer);
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                document.getElementById('currentUserName').textContent = user.username;
                
                loadUserNotes();
                startSubscriptionTimer();
                checkFeatureAccess();
                loadSubscriptionManagementContent();
                setTimeout(initializeFileInputs, 100);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            initializeData();
            checkAuth();
        };

        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>